{% extends "base.html" %}
{% block title %}Checkout — Crafty{% endblock %}
{% block content %}
  <h1>Checkout</h1>

  <ul>
    {% for it in items %}
      <li>{{ it.product.title }} — Qty: {{ it.quantity }} — ₹{{ it.total }}</li>
    {% endfor %}
  </ul>
  <p><strong>Total: ₹{{ total }}</strong></p>

  <button id="pay-now">Pay with Razorpay</button>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    // read cookie helper (Django-style)
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    document.getElementById('pay-now').addEventListener('click', async function () {
      try {
        const csrftoken = getCookie('csrftoken');

        // create Razorpay order on server
        const createResp = await fetch("{% url 'checkout' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({}) // no body needed; server uses session
        });

        if (!createResp.ok) {
          const txt = await createResp.text();
          alert("Could not create order: " + txt);
          return;
        }

        const data = await createResp.json();

        const options = {
          key: data.razorpay_key_id,
          amount: data.amount_paise, // in paise
          currency: data.currency,
          name: "Crafty",
          description: `Order #${data.order_id}`,
          order_id: data.razorpay_order_id,
          handler: function (response) {
            // verify payment on server
            fetch("{% url 'verify_payment' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
              },
              body: JSON.stringify({
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                order_id: data.order_id
              })
            })
            .then(r => r.json())
            .then(res => {
              if (res.status === "ok") {
                alert("Payment successful — Order #" + res.order_id);
                window.location.href = "{% url 'product_list' %}";
              } else {
                alert("Payment verification failed. See console for details.");
                console.error(res);
              }
            })
            .catch(err => {
              alert("Error verifying payment. Check console.");
              console.error(err);
            });
          },
          prefill: {
            name: "{{ request.user.get_full_name|default:request.user.username }}",
            email: "{{ request.user.email }}"
          },
          theme: { color: "#0ea5a5" }
        };

        const rzp = new Razorpay(options);
        rzp.open();

      } catch (err) {
        console.error("Checkout error:", err);
        alert("Checkout failed. See console.");
      }
    });
  </script>
{% endblock %}
