{% extends "base.html" %}
{% block title %}Browse · Crafty{% endblock %}

{% block content %}
    <section class="container" style="margin-top: var(--spacing-lg);">
        <h1>Browse Art & Products</h1>

        <form method="get" class="search-form" style="margin-bottom: var(--spacing-lg); display: flex; gap: var(--spacing-sm);">
            <input type="search" name="q" value="{{ q }}" placeholder="Search products..." class="search-input" />
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <div class="product-grid">
            {% for product in page_obj.object_list %}
                <article class="product-card">
                    <a href="{{ product.get_absolute_url }}" class="product-image-container">
                        {% if product.is_local_artisan %}
                            <span class="local-artisan-tag">Local Artisan</span>
                        {% endif %}
                        {% if product.images.first %}
                            <img src="{{ product.images.first.image.url }}" alt="{{ product.title }}" class="product-image" />
                        {% else %}
                            <div class="product-image placeholder">No image</div>
                        {% endif %}
                    </a>
                    <div class="product-details">
                        <div>
                            <h3><a href="{{ product.get_absolute_url }}">{{ product.title }}</a></h3>
                            <p class="product-price">{{ product.get_price_display }}</p>
                        </div>
                        
                        <form method="post" action="{% url 'add_to_cart' product.pk %}" class="quick-add-form">
                            {% csrf_token %}
                            <input type="hidden" name="qty" value="1" />
                            <button type="submit" class="add-to-cart-btn">Quick Add</button>
                        </form>
                        </div>
                </article>
            {% empty %}
                <p>No products found matching your criteria.</p>
            {% endfor %}
        </div>

        <div class="pagination" style="margin-top: var(--spacing-xl); text-align: center; display: flex; justify-content: center; gap: var(--spacing-md);">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline">← Previous</a>
            {% endif %}
            <span style="align-self: center; color: var(--color-text-muted);">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline">Next →</a>
            {% endif %}
        </div>
    </section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Check if configuration object is available (from base.html)
    if (typeof CraftyConfig === 'undefined') {
        console.error('CraftyConfig is missing. Cannot initialize cart AJAX.');
        return;
    }

    // Selectors
    const cartIconAndText = document.querySelector('.cart-link'); 
    const cartDrawer = document.getElementById('cart-drawer');
    const cartBody = document.getElementById('cart-drawer-body');
    const cartClose = document.getElementById('cart-close');
    const backdrop = document.getElementById('drawer-backdrop');
    const cartCountEl = document.getElementById('cart-count'); 

    // Utility function to get CSRF token
    function getCookie(name) {
        const v = `; ${document.cookie}`;
        const parts = v.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // Helper to animate and set count
    function setCartCount(n) {
        if (!cartCountEl) return;
        cartCountEl.textContent = n;
        // Animation effect
        cartCountEl.style.transform = 'scale(1.15)';
        setTimeout(() => cartCountEl.style.transform = '', 140);
    }
    window.setCartCount = setCartCount; 

    // Drawer functions (assuming translate-x-full classes control visibility)
    function openDrawer() {
        if (!cartDrawer || !backdrop) return;
        cartDrawer.classList.remove('translate-x-full');
        backdrop.classList.remove('hidden');
    }
    function closeDrawer() {
        if (!cartDrawer || !backdrop) return;
        cartDrawer.classList.add('translate-x-full');
        backdrop.classList.add('hidden');
    }

    // Event listener for opening the drawer (replaces cartBtn listener)
    cartIconAndText?.addEventListener('click', async (e) => {
        e.preventDefault(); 
        openDrawer();
        
        try {
            if (cartBody) {
                 cartBody.innerHTML = '<div class="p-8 text-center text-gray-500">Loading cart...</div>';
            }
            const res = await fetch(CraftyConfig.cartUrl); 
            if (res.ok) {
                const html = await res.text();
                cartBody.innerHTML = html;
            } else {
                cartBody.innerHTML = '<div class="p-8 text-red-500">Could not load cart.</div>';
            }
        } catch (err) {
            cartBody.innerHTML = '<div class="p-8 text-red-500">Network error.</div>';
        }
    });

    cartClose?.addEventListener('click', closeDrawer);
    backdrop?.addEventListener('click', closeDrawer);

    // load initial count
    (async function loadCount() {
        try {
            const r = await fetch(CraftyConfig.cartCountUrl); 
            if (r.ok) {
                const j = await r.json();
                setCartCount(j.count || 0);
            }
        } catch (e) { /* ignore */ }
    })();

    // Intercept add-to-cart forms (both quick-add and detail page)
    document.addEventListener('submit', async function (e) {
        const form = e.target;
        
        // Ensure it's one of our AJAX cart forms
        if (!form.classList.contains('quick-add-form') && !form.classList.contains('add-to-cart-form')) {
            return;
        }

        e.preventDefault(); // Stop the default submission/redirect

        const submitBtn = form.querySelector('button[type="submit"]');
        const csrftoken = getCookie('csrftoken');
        
        // --- Button State and Pre-Check ---
        if (!submitBtn || !csrftoken) {
            console.error('Missing submit button or CSRF token.');
            return;
        }
        
        // CRITICAL: Disable button immediately to prevent double-click
        if (submitBtn.disabled) {
            return; 
        }
        submitBtn.disabled = true;
        submitBtn.dataset.origText = submitBtn.textContent;
        submitBtn.textContent = 'Adding...';

        const url = form.action;
        const formData = new FormData(form);

        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });

            if (resp.ok) {
                const json = await resp.json().catch(() => null);
                
                // 1. Update Cart Count
                let newCount = null;
                if (json && typeof json.count !== 'undefined') {
                    newCount = json.count;
                } else {
                    // Refetch count if not in JSON (fallback)
                    try {
                        const cc = await fetch(CraftyConfig.cartCountUrl); 
                        if (cc.ok) {
                            const jj = await cc.json();
                            newCount = jj.count;
                        }
                    } catch { /* silent fail */ }
                }
                
                if (newCount !== null) {
                    setCartCount(newCount || 0);
                }

                // --- FIX: Restore "Added ✓" feedback ---
                // Show temporary success message
                submitBtn.textContent = 'Added ✓'; 
                
                // Restore button state after a delay
                setTimeout(() => {
                    submitBtn.textContent = submitBtn.dataset.origText || 'Quick Add';
                    submitBtn.disabled = false;
                }, 1200);

                // Open drawer and refresh its body
                cartIconAndText?.click();

            } else {
                // Server error (e.g., validation failed)
                submitBtn.textContent = submitBtn.dataset.origText || 'Quick Add';
                submitBtn.disabled = false;
                form.submit(); // Fallback to full submit for error handling
            }
        } catch (err) {
            // Network error
            submitBtn.textContent = submitBtn.dataset.origText || 'Quick Add';
            submitBtn.disabled = false;
            form.submit(); // Fallback to full submit
        }
    }, false);
});
</script>
{% endblock %}