{% extends "base.html" %}
{% load static %}
{% block title %}Browse · Crafty{% endblock %}

{% block content %}
    <section class="container" style="padding-top: var(--spacing-lg); padding-bottom: var(--spacing-xl);">
        
        <!-- Main Title -->
        <h1 style="font-size: 2.5rem; margin-bottom: 24px;">Browse Art & Products</h1>

        <!-- 1. Primary Search Bar (Top Row) -->
        <div class="primary-search-bar" style="display: flex; gap: 8px; margin-bottom: 32px;">
            <form method="get" class="search-form-primary" style="display: flex; width: 100%;">
                <input type="search" name="q" value="{{ q }}" placeholder="Search products..." class="search-input" style="flex: 1; padding: 12px 16px; border: 1px solid var(--color-primary-dark); background: var(--color-background); color: var(--color-text); border-radius: 4px 0 0 4px; font-size: 1rem;" />
                <button type="submit" class="btn btn-primary" style="padding: 12px 16px; border-radius: 0 4px 4px 0; font-weight: 600;">Search</button>
            </form>
        </div>

        <!-- 2. Secondary Filter & Sort Bar (Horizontal Alignment) -->
        <form id="filters-form" method="get" class="filters secondary-filter-bar" style="
            display: flex;
            gap: 8px; /* Space between filter inputs */
            align-items: flex-end; /* CRITICAL: Aligns all inputs and buttons to the bottom */
            flex-wrap: wrap; 
            padding: 16px 0;
            margin-bottom: 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        ">

            <!-- Filter 1: Category -->
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 0.95rem; color: var(--color-text-muted); font-weight: 600;">Category</label>
                <select name="category" class="form-select filter-select" style="padding: 8px 12px; border: 1px solid var(--color-primary-dark); border-radius: 4px; background-color: var(--color-background); color: var(--color-text); font-size: 0.95rem; height: 38px;">
                    <option value="all" {% if active_filters.category == "all" or active_filters.category == "" %}selected{% endif %}>All categories</option>
                    {% for c in categories %}
                        <option value="{{ c.slug }}" {% if active_filters.category == c.slug %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Filter 2: Location -->
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 0.95rem; color: var(--color-text-muted); font-weight: 600;">Location</label>
                <select name="city" class="form-select filter-select" style="padding: 8px 12px; border: 1px solid var(--color-primary-dark); border-radius: 4px; background-color: var(--color-background); color: var(--color-text); font-size: 0.95rem; height: 38px;">
                    <option value="">All locations</option>
                    {% for c in cities %}
                        <option value="{{ c }}" {% if active_filters.city == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Price Range (Horizontal Inputs) -->
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 0.95rem; color: var(--color-text-muted); font-weight: 600;">Price Range (₹)</label>
                <div style="display: flex; gap: 4px; align-items: center;">
                    <!-- Min Input -->
                    <input type="number" name="min_price" placeholder="min" value="{{ active_filters.min_price }}" style="width: 70px; padding: 8px; border: 1px solid var(--color-primary-dark); border-radius: 4px; background-color: var(--color-background); color: var(--color-text); text-align: center; font-size: 0.95rem; height: 38px;">
                    <span style="color: var(--color-text-muted);">—</span>
                    <!-- Max Input -->
                    <input type="number" name="max_price" placeholder="max" value="{{ active_filters.max_price }}" style="width: 70px; padding: 8px; border: 1px solid var(--color-primary-dark); border-radius: 4px; background-color: var(--color-background); color: var(--color-text); text-align: center; font-size: 0.95rem; height: 38px;">
                </div>
            </div>
            
            <!-- Sorting -->
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 0.95rem; color: var(--color-text-muted); font-weight: 600;">Sort By</label>
                <select name="sort" class="form-select filter-select" style="padding: 8px 12px; border: 1px solid var(--color-primary-dark); border-radius: 4px; background-color: var(--color-background); color: var(--color-text); font-size: 0.95rem; height: 38px;">
                    <option value="">Sort (newest)</option>
                    <option value="asc" {% if active_filters.sort == "asc" %}selected{% endif %}>Price: low → high</option>
                    <option value="desc" {% if active_filters.sort == "desc" %}selected{% endif %}>Price: high → low</option>
                </select>
            </div>

            <!-- Action Buttons (No Label, Aligned with Inputs) -->
            <div style="display: flex; gap: 8px; align-items: flex-end;">
                <button type="submit" class="btn btn-primary" style="padding: 8px 16px; height: 38px;">Apply</button>
                <a href="{% url 'product_list' %}" class="btn btn-outline" style="padding: 8px 16px; height: 38px;">Reset</a>
            </div>
        </form>

        <!-- Product Grid -->
        <div class="product-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--spacing-md);">
            {% for product in page_obj.object_list %}
                <article class="product-card" style="background-color: var(--color-surface); border-radius: 8px; overflow: hidden;">
                    <a href="{% url 'product_detail' product.slug %}" class="product-image-container" style="display: block; height: 200px; overflow: hidden;">
                        {% if product.is_local_artisan %}
                            <span class="local-artisan-tag" style="position: absolute; top: 8px; left: 8px; background-color: var(--color-primary); color: var(--color-background); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; z-index: 10;">Local Artisan</span>
                        {% endif %}
                        {% if product.images.first %}
                            <img src="{{ product.images.first.image.url }}" alt="{{ product.title }}" class="product-image" style="width: 100%; height: 100%; object-fit: cover;" />
                        {% else %}
                            <img src="{% static 'images/product_placeholder.jpg' %}" alt="{{ product.title }}" class="product-image" style="width: 100%; height: 100%; object-fit: cover;" />
                        {% endif %}
                    </a>
                    <div class="product-details" style="padding: 16px;">
                        <div>
                            <h3 style="font-size: 1.1rem; margin: 0 0 4px 0;"><a href="{{ product.get_absolute_url }}" style="color: var(--color-text); text-decoration: none;">{{ product.title }}</a></h3>
                            <p class="product-price" style="font-size: 1.2rem; font-weight: 700; color: var(--color-primary); margin: 0 0 8px 0;">{{ product.get_price_display }}</p>
                        </div>
                        
                        <span>₹ {{product.price}}</span>
                        <form method="post" action="{% url 'add_to_cart' product.pk %}" class="quick-add-form">
                            {% csrf_token %}
                            <input type="hidden" name="qty" value="1" />
                            <button type="submit" class="add-to-cart-btn" style="width: 100%; padding: 8px; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Quick Add</button>
                        </form>
                    </div>
                </article>
            {% empty %}
                <p>No products found matching your criteria.</p>
            {% endfor %}
        </div>

        <!-- Pagination -->
        <div class="pagination" style="margin-top: var(--spacing-xl); text-align: center; display: flex; justify-content: center; gap: var(--spacing-md);">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline">← Previous</a>
            {% endif %}
            <span style="align-self: center; color: var(--color-text-muted);">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline">Next →</a>
            {% endif %}
        </div>
    </section>

<!-- NOTE: Keeping the reusable JS block, but separated for clarity -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Check if configuration object is available (from base.html)
    if (typeof CraftyConfig === 'undefined') {
        // console.error('CraftyConfig is missing. Cannot initialize cart AJAX.');
        // return;
        // In this final context, assume global variables are available or skip AJAX
    }
    
    // Utility function to get CSRF token
    function getCookie(name) {
        const v = `; ${document.cookie}`;
        const parts = v.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    // Find count element (if present)
    const cartCountEl = document.getElementById('cart-count'); 
    
    // Helper to animate and set count
    function setCartCount(n) {
        if (!cartCountEl) return;
        cartCountEl.textContent = n;
        cartCountEl.style.transform = 'scale(1.15)';
        setTimeout(() => cartCountEl.style.transform = '', 140);
    }
    window.setCartCount = setCartCount; 


    // Intercept add-to-cart forms 
    document.addEventListener('submit', async function (e) {
        const form = e.target;
        
        if (!form.classList.contains('quick-add-form') && !form.classList.contains('add-to-cart-form')) {
            return;
        }

        e.preventDefault(); 

        const submitBtn = form.querySelector('button[type="submit"]');
        const csrftoken = getCookie('csrftoken');
        const url = form.action;
        const formData = new FormData(form);
        
        if (!submitBtn || !csrftoken || !window.setCartCount) { return; }
        
        // CRITICAL: Disable button immediately 
        if (submitBtn.disabled) { return; }
        submitBtn.disabled = true;
        submitBtn.dataset.origText = submitBtn.textContent;
        submitBtn.textContent = 'Adding...';

        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken },
                body: formData
            });

            if (resp.ok) {
                const json = await resp.json().catch(() => null);
                
                // Update Cart Count
                let newCount = (json && typeof json.count !== 'undefined') ? json.count : null;
                if (newCount === null && typeof CraftyConfig !== 'undefined' && CraftyConfig.cartCountUrl) {
                    const cc = await fetch(CraftyConfig.cartCountUrl); 
                    if (cc.ok) { newCount = (await cc.json()).count; }
                }
                if (newCount !== null) { setCartCount(newCount || 0); }

                // --- FIX: Restore "Added ✓" feedback ---
                submitBtn.textContent = 'Added ✓'; 
                setTimeout(() => {
                    submitBtn.textContent = submitBtn.dataset.origText || 'Quick Add';
                    submitBtn.disabled = false;
                }, 1100);

                if (cartCountEl) {
                    cartCountEl.style.transform = 'scale(1.35)';
                    cartCountEl.style.transition = 'transform 160ms ease';
                    setTimeout(() => { cartCountEl.style.transform = ''; }, 160);
                }

            } else {
                submitBtn.textContent = submitBtn.dataset.origText || 'Quick Add';
                submitBtn.disabled = false;
                form.submit(); 
            }
        } catch (err) {
            submitBtn.textContent = submitBtn.dataset.origText || 'Quick Add';
            submitBtn.disabled = false;
            form.submit(); 
        }
    }, false);
});
</script>
{% endblock %}