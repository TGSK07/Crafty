{% extends "base.html" %}
{% block title %}{% if product %}Edit{% else %}Create{% endif %} Product · Crafty{% endblock %}
{% block content %}
<h1>{% if product %}Edit{% else %}Create{% endif %} Product</h1>

<!-- MAIN PRODUCT FORM (no nested forms inside) -->
<form id="product-main-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.non_field_errors }}
  <div>{{ form.title.label_tag }} {{ form.title }}</div>
  <div>{{ form.category.label_tag }} {{ form.category }}</div>
  <div>{{ form.description.label_tag }} {{ form.description }}</div>
  <div>{{ form.price.label_tag }} {{ form.price }} <small>enter amount in paise (e.g. 10000 = ₹100)</small></div>
  <div>{{ form.stock.label_tag }} {{ form.stock }}</div>
  <div>{{ form.is_active.label_tag }} {{ form.is_active }}</div>

  <hr />
  <div>
    <label for="id_images">Product Images (you can select multiple)</label><br>
    <input type="file" id="id_images" name="images" multiple accept="image/*">
    <p><small>Allowed types: jpg, jpeg, png, webp. Max 4MB each.</small></p>
  </div>

  <div id="preview" style="display:flex; gap: 8px; margin-top: 8px;"></div>

  <button type="submit" id="save-product-btn">Save</button>
</form>
<!-- END MAIN PRODUCT FORM -->

<!-- EXISTING IMAGES SECTION (outside main form) -->
{% if product and product.images.all %}
  <h4>Existing Images</h4>
  <div class="existing-images" style="display:flex; gap:12px; flex-wrap:wrap;">
    {% for img in product.images.all %}
      <div class="img-item" style="text-align:center; border:1px solid #eee; padding:6px;">
        <img src="{{ img.image.url }}" alt="{{ img.alt_text }}" style="max-width:160px; display:block; object-fit:cover; height:120px;">
        <!-- Separate form for deletion (not nested) -->
        <form method="post" action="{% url 'product_image_delete' img.pk %}" style="margin-top:6px;">
          {% csrf_token %}
          <button type="submit" onclick="return confirm('Remove this image?');">Remove</button>
        </form>
      </div>
    {% endfor %}
  </div>
{% endif %}

<script>
  // simple client-side preview for chosen images
  const input = document.getElementById('id_images');
  const preview = document.getElementById('preview');
  if (input) {
    input.addEventListener('change', (e) => {
      preview.innerHTML = '';
      const files = Array.from(e.target.files).slice(0, 6); // limit previews
      files.forEach(file => {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = '120px';
        img.style.maxHeight = '120px';
        img.style.objectFit = 'cover';
        preview.appendChild(img);
      });
    });
  }
</script>
{% endblock %}
